<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rider-PC — Google Feed</title>
  <link rel="stylesheet" href="/web/assets/dashboard-common.css">
  <link rel="stylesheet" href="/web/assets/home.css">
</head>
<body data-page="home">
<div data-dashboard-menu-target></div>
<div class="wrap">
  
  <h1>
    <span class="brand-accent">Rider-PC</span>
    <span>— Google Feed</span>
    <span id="stateBadge" class="c-pill warn">
      <span class="spinner"></span> Loading...
    </span>
  </h1>

  <!-- Status Card -->
  <div class="c-card">
    <h2 class="c-card__title">Status &amp; Metrics</h2>
    
    <div class="c-kv data-list">
      <div class="data-label">State:</div>
      <div class="data-value" id="stateValue">—</div>

      <div class="data-label">Last Update:</div>
      <div class="data-value" id="timestampValue">—</div>

      <div class="data-label">Requests (24h):</div>
      <div class="data-value" id="requestsValue">—</div>

      <div class="data-label">Errors (24h):</div>
      <div class="data-value" id="errorsValue">—</div>
    </div>
  </div>

  <!-- Snapshot Card -->
  <div class="c-card">
    <h2 class="c-card__title">Last Snapshot</h2>
    <pre id="snapshotData" class="snapshot muted">No data available</pre>
  </div>
  </div>
<div data-dashboard-footer-target></div>

<!-- App Logic -->
<script type="module">
  const POLL_INTERVAL_MS = 5000; // 5 seconds

  const qs = (s) => document.querySelector(s);
  
  function formatTimestamp(ts) {
    if (!ts || ts === 0) return '—';
    const d = new Date(ts * 1000);
    return d.toLocaleString('pl-PL', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }

  function updateStateBadge(state) {
    const badge = qs('#stateBadge');
    const stateMap = {
      'ok': { text: 'OK', class: 'c-pill ok' },
      'enabled': { text: 'Enabled', class: 'c-pill warn' },
      'error': { text: 'Error', class: 'c-pill err' },
      'off': { text: 'Off', class: 'c-pill off' }
    };
    
    const config = stateMap[state] || { text: 'Unknown', class: 'c-pill warn' };
    badge.textContent = config.text;
    badge.className = config.class;
  }

  async function fetchStatus() {
    try {
      const response = await fetch('/api/google/status', { cache: 'no-store' });
      const data = await response.json();
      
      // Update state badge
      updateStateBadge(data.state || 'off');
      
      // Update status values
      qs('#stateValue').textContent = data.state || 'unknown';
      qs('#timestampValue').textContent = formatTimestamp(data.timestamp);
      qs('#requestsValue').textContent = data.metrics?.requests_24h ?? 0;
      qs('#errorsValue').textContent = data.metrics?.errors_24h ?? 0;
      
    } catch (e) {
      console.error('Failed to fetch status:', e);
      updateStateBadge('error');
      qs('#stateValue').textContent = 'error';
    }
  }

  async function fetchSnapshot() {
    try {
      const response = await fetch('/api/google/raw/last.json', { cache: 'no-store' });
      
      // Handle 404 (no snapshot) explicitly
      if (response.status === 404) {
        qs('#snapshotData').textContent = 'No snapshot available yet';
        return;
      }
      
      const data = await response.json();
      
      // Pretty print JSON
      qs('#snapshotData').textContent = JSON.stringify(data, null, 2);
      
    } catch (e) {
      console.error('Failed to fetch snapshot:', e);
      qs('#snapshotData').textContent = 'Error loading snapshot';
    }
  }

  async function updateAll() {
    await Promise.all([fetchStatus(), fetchSnapshot()]);
  }

  // Initial update
  updateAll();

  // Poll every 5 seconds
  setInterval(updateAll, POLL_INTERVAL_MS);
</script>
<script type="module" src="/web/assets/menu.js"></script>
<script type="module" src="/web/assets/footer.js"></script>

</body>
</html>
