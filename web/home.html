<!doctype html>
<!--
  Migrated to dashboard_base.html template structure
  Uses shared layout classes: .layout-header, .layout-main, .layout-footer
-->
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rider-PC: Google Feed</title>
  <script src="/web/assets/theme-loader.js" defer></script>
  <link rel="stylesheet" href="/web/assets/dashboard-common.css">
  <link rel="stylesheet" href="/web/assets/themes/classic/theme.css" data-theme-skin="classic">
  <link rel="stylesheet" href="/web/assets/themes/classic-plus/theme.css" data-theme-skin="classic-plus" disabled>
  <link rel="stylesheet" href="/web/assets/themes/v2/theme.css" data-theme-skin="v2" disabled>
  <link rel="stylesheet" href="/web/assets/themes/v3/theme.css" data-theme-skin="v3" disabled>
  <link rel="stylesheet" href="/web/assets/pages/home.css">
</head>
<body data-page="home" class="page page-home">
  <!-- Header with Menu -->
  <header class="layout-header" data-dashboard-menu-target></header>

  <!-- Main content -->
  <main class="layout-main">
    <!-- Page header -->
    <header class="page-header">
      <div class="page-header__titles">
        <h1 class="page-title">
          <span class="brand-accent">Rider-PC</span>: <span class="page-title-text">Google Feed</span>
        </h1>
      </div>
      <div class="page-header__actions page-header__actions--small text-legend">
        <span id="stateBadge" class="c-pill is-warn">
          <span class="c-spinner"></span> Loading...
        </span>
      </div>
    </header>

    <!-- Status Card -->
    <section class="c-card u-mb-xl">
      <h2 class="c-card__title">Status &amp; Metrics</h2>
      
      <div class="c-data-list">
        <div class="c-data-list__item">
          <span class="c-data-list__label">State:</span>
          <span class="c-data-list__value" id="stateValue">—</span>
        </div>
        <div class="c-data-list__item">
          <span class="c-data-list__label">Last Update:</span>
          <span class="c-data-list__value" id="timestampValue">—</span>
        </div>
        <div class="c-data-list__item">
          <span class="c-data-list__label">Requests (24h):</span>
          <span class="c-data-list__value" id="requestsValue">—</span>
        </div>
        <div class="c-data-list__item">
          <span class="c-data-list__label">Errors (24h):</span>
          <span class="c-data-list__value" id="errorsValue">—</span>
        </div>
      </div>
    </section>

    <!-- Snapshot Card -->
    <section class="c-card">
      <h2 class="c-card__title">Last Snapshot</h2>
      <pre id="snapshotData" class="c-code-block u-muted">No data available</pre>
    </section>
  </main>

  <!-- Footer -->
  <footer class="layout-footer" data-dashboard-footer-target></footer>

<!-- App Logic -->
<script type="module">
  const POLL_INTERVAL_MS = 5000; // 5 seconds

  const qs = (s) => document.querySelector(s);
  
  function formatTimestamp(ts) {
    if (!ts || ts === 0) return '—';
    const d = new Date(ts * 1000);
    return d.toLocaleString('pl-PL', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });
  }

  function updateStateBadge(state) {
    const badge = qs('#stateBadge');
    const stateMap = {
      'ok': { text: 'OK', class: 'c-pill is-ok' },
      'enabled': { text: 'Enabled', class: 'c-pill is-warn' },
      'error': { text: 'Error', class: 'c-pill is-err' },
      'off': { text: 'Off', class: 'c-pill is-off' }
    };
    
    const config = stateMap[state] || { text: 'Unknown', class: 'c-pill is-warn' };
    badge.textContent = config.text;
    badge.className = config.class;
  }

  async function fetchStatus() {
    try {
      const response = await fetch('/api/google/status', { cache: 'no-store' });
      const data = await response.json();
      
      // Update state badge
      updateStateBadge(data.state || 'off');
      
      // Update status values
      qs('#stateValue').textContent = data.state || 'unknown';
      qs('#timestampValue').textContent = formatTimestamp(data.timestamp);
      qs('#requestsValue').textContent = data.metrics?.requests_24h ?? 0;
      qs('#errorsValue').textContent = data.metrics?.errors_24h ?? 0;
      
    } catch (e) {
      console.error('Failed to fetch status:', e);
      updateStateBadge('error');
      qs('#stateValue').textContent = 'error';
    }
  }

  async function fetchSnapshot() {
    try {
      const response = await fetch('/api/google/raw/last.json', { cache: 'no-store' });
      
      // Handle 404 (no snapshot) explicitly
      if (response.status === 404) {
        qs('#snapshotData').textContent = 'No snapshot available yet';
        return;
      }
      
      const data = await response.json();
      
      // Pretty print JSON
      qs('#snapshotData').textContent = JSON.stringify(data, null, 2);
      
    } catch (e) {
      console.error('Failed to fetch snapshot:', e);
      qs('#snapshotData').textContent = 'Error loading snapshot';
    }
  }

  async function updateAll() {
    await Promise.all([fetchStatus(), fetchSnapshot()]);
  }

  // Initial update
  updateAll();

  // Poll every 5 seconds
  setInterval(updateAll, POLL_INTERVAL_MS);
</script>
<script type="module" src="/web/assets/menu.js"></script>
<script type="module" src="/web/assets/footer.js"></script>

</body>
</html>
