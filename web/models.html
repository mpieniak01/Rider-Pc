<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rider-PC: AI Command Center</title>
  <script src="/web/assets/theme-loader.js" defer></script>
  <link rel="stylesheet" href="/web/assets/dashboard-common.css">
  <link rel="stylesheet" href="/web/assets/themes/classic/theme.css" data-theme-skin="classic">
  <link rel="stylesheet" href="/web/assets/themes/classic-plus/theme.css" data-theme-skin="classic-plus" disabled>

  <link rel="stylesheet" href="/web/assets/themes/v3/theme.css" data-theme-skin="v3" disabled>
  <link rel="stylesheet" href="/web/assets/pages/models-base.css">
  <link rel="stylesheet" href="/web/assets/pages/models-v2.css" data-theme-page="v2" disabled>
  <link rel="stylesheet" href="/web/assets/pages/models-v3.css" data-theme-page="v3" disabled>
</head>
<body data-page="models" class="page page-models">
  <header class="layout-header" data-dashboard-menu-target></header>

  <main class="layout-main layout-main--wide">
    <header class="page-header">
      <div class="page-header__titles">
        <h1 class="page-title">AI Command Center</h1>
        <p class="page-subtitle text-secondary">Centralne zarzƒÖdzanie m√≥zgiem (PC) i robotem (Pi).</p>
      </div>
      <div class="page-header__actions">
        <div id="global-status" class="c-pill is-working">Inicjalizacja...</div>
      </div>
    </header>

    <section class="c-section pipeline-section section-pc">
      <div class="section-header-flex">
         <h2 class="section-title">üñ•Ô∏è Rider-PC Pipeline (M√≥zg)</h2>
      </div>
      
      <div class="l-grid l-grid--3-cols">
        
        <div class="c-card pipeline-card pc-card" id="card-pc-text" data-domain="text" data-device="pc">
          <div class="pipeline-card-header">
            <span class="icon">üí¨</span> Text / LLM (PC)
          </div>
          <div class="pipeline-card-body">
             <div class="active-status-bar">
                <span class="label">Aktywny:</span> <strong class="value status-value">≈Åadowanie...</strong>
             </div>
             
             <div class="control-group u-mt-md">
               <label class="c-label-sm">≈πr√≥d≈Ço (Source)</label>
               <select class="c-select source-select">
                 <option value="local" selected>üñ•Ô∏è Lokalny (Ollama/GPU)</option>
                 <option value="cloud">‚òÅÔ∏è Chmura (API)</option>
               </select>
             </div>
             <div class="control-group">
               <label class="c-label-sm">Model</label>
               <select class="c-select model-select">
                 <option>≈Åadowanie danych...</option>
               </select>
             </div>
             <button class="c-btn c-btn--primary c-btn-sm save-btn">Zapisz konfiguracjƒô PC</button>
          </div>
        </div>

        <div class="c-card pipeline-card pc-card" id="card-pc-vision" data-domain="vision" data-device="pc">
          <div class="pipeline-card-header">
            <span class="icon">üëÅÔ∏è</span> Vision (PC)
          </div>
          <div class="pipeline-card-body">
             <div class="active-status-bar">
                <span class="label">Aktywny:</span> <strong class="value status-value">≈Åadowanie...</strong>
             </div>
             <div class="control-group u-mt-md">
               <label class="c-label-sm">≈πr√≥d≈Ço (Source)</label>
               <select class="c-select source-select">
                 <option value="local" selected>üñ•Ô∏è Lokalny (YOLO/ONNX)</option>
                 <option value="cloud" disabled>‚òÅÔ∏è Chmura (Wkr√≥tce)</option>
               </select>
             </div>
             <div class="control-group">
               <label class="c-label-sm">Model</label>
               <select class="c-select model-select">
                 <option value="yolo-v8-m" selected>yolo-v8-m (Default)</option>
               </select>
             </div>
             <button class="c-btn c-btn--primary c-btn-sm save-btn">Zapisz konfiguracjƒô PC</button>
          </div>
        </div>

        <div class="c-card pipeline-card pc-card" id="card-pc-voice" data-domain="voice" data-device="pc">
          <div class="pipeline-card-header">
            <span class="icon">üó£Ô∏è</span> Voice ASR/TTS (PC)
          </div>
          <div class="pipeline-card-body">
             <div class="active-status-bar">
                <span class="label">Aktywny:</span> <strong class="value status-value">≈Åadowanie...</strong>
             </div>
             <div class="control-group u-mt-md">
               <label class="c-label-sm">≈πr√≥d≈Ço (Source)</label>
               <select class="c-select source-select">
                 <option value="local" selected>üñ•Ô∏è Lokalny (Whisper)</option>
                 <option value="cloud">‚òÅÔ∏è Chmura (OpenAI)</option>
               </select>
             </div>
              <div class="control-group">
               <label class="c-label-sm">Model</label>
               <select class="c-select model-select">
                 <option value="whisper-base">whisper-base (ASR)</option>
               </select>
             </div>
             <button class="c-btn c-btn--primary c-btn-sm save-btn">Zapisz konfiguracjƒô PC</button>
          </div>
        </div>

      </div>
    </section>

    <section class="c-section pipeline-section section-pi u-mt-xl">
      <div class="section-header-flex">
          <h2 class="section-title">ü§ñ Rider-Pi Pipeline (Robot)</h2>
          <div class="c-pill is-off" id="pi-connection-status">Pi Offline</div>
      </div>
      
      <div class="l-grid l-grid--3-cols">
        
        <div class="c-card pipeline-card pi-card" id="card-pi-text" data-domain="text" data-device="pi">
          <div class="pipeline-card-header">
            <span class="icon">üí¨</span> Text / LLM (Pi Edge)
          </div>
          <div class="pipeline-card-body">
             <div class="active-status-bar">
                <span class="label">Aktywny:</span> <strong class="value status-value">‚Äî</strong>
             </div>
             <div class="control-group u-mt-md">
               <label class="c-label-sm">≈πr√≥d≈Ço (Source)</label>
               <select class="c-select source-select" disabled>
                 <option value="local" selected>ü§ñ Lokalny (Edge CPU)</option>
               </select>
             </div>
             <div class="control-group">
               <label class="c-label-sm">Model</label>
               <select class="c-select model-select" disabled>
                 <option>Brak po≈ÇƒÖczenia</option>
               </select>
             </div>
             <button class="c-btn c-btn--primary c-btn-sm save-btn" disabled>Wy≈õlij do Pi</button>
          </div>
        </div>

        <div class="c-card pipeline-card pi-card disabled-card">
          <div class="pipeline-card-header">
            <span class="icon">üëÅÔ∏è</span> Vision (Pi Edge)
          </div>
           <div class="pipeline-card-body">
             <div class="active-status-bar"><span class="label">Aktywny:</span> <strong class="value">‚Äî</strong></div>
             <p class="c-hint u-mt-md">Pi u≈ºywa wbudowanego, lekkiego modelu detekcji (niekonfigurowalne).</p>
          </div>
        </div>

        <div class="c-card pipeline-card pi-card disabled-card">
          <div class="pipeline-card-header">
            <span class="icon">üó£Ô∏è</span> Voice (Pi Edge)
          </div>
          <div class="pipeline-card-body">
             <div class="active-status-bar"><span class="label">Aktywny:</span> <strong class="value">‚Äî</strong></div>
             <p class="c-hint u-mt-md">Pi u≈ºywa wbudowanego silnika komend g≈Çosowych (niekonfigurowalne).</p>
          </div>
        </div>

      </div>
    </section>

    <section class="c-section u-mt-xl">
      <h2 class="section-title">‚öôÔ∏è Engines & Keys (Zaplecze)</h2>
      <div class="l-grid l-grid--3-cols">
          
          <div class="c-card engine-card">
              <h3 class="engine-title">‚òÅÔ∏è Klucze API Chmury</h3>
              <div class="engine-body">
                  <div class="key-status-row">
                      <span>Google Gemini:</span>
                      <span class="c-pill c-pill--sm is-off" id="key-status-gemini">Brak</span>
                  </div>
                  <div class="key-status-row">
                      <span>OpenAI (GPT):</span>
                      <span class="c-pill c-pill--sm is-off" id="key-status-chatgpt">Brak</span>
                  </div>
                  <p class="c-hint u-mt-md">Status kluczy zdefiniowanych w pliku `.env` na PC.</p>
              </div>
          </div>

           <div class="c-card engine-card">
              <h3 class="engine-title">üñ•Ô∏è Silnik PC (Ollama/GPU)</h3>
              <div class="engine-body">
                  <div id="pc-engine-status" class="u-mb-md">Sprawdzanie...</div>
                  <button class="c-btn c-btn-sm c-btn--ghost" onclick="loadAllData()">Od≈õwie≈º status</button>
              </div>
          </div>

           <div class="c-card engine-card">
              <div class="section-header-flex u-mb-sm">
                  <h3 class="engine-title u-mb-0">ü§ñ Silnik Rider-Pi (Health)</h3>
                  <button class="c-btn c-btn-sm c-btn--ghost icon-only" id="btn-refresh-pi" disabled title="Od≈õwie≈º Pi">üîÑ</button>
              </div>
              <div class="engine-body">
                  <div class="pi-health-grid">
                      <div><span>Ping</span><strong id="pi-health-ping">‚Äî</strong></div>
                      <div><span>CPU</span><strong id="pi-health-cpu">‚Äî</strong></div>
                      <div><span>Temp</span><strong id="pi-health-temp">‚Äî</strong></div> 
                  </div>
              </div>
          </div>

      </div>
    </section>

  </main>
  <footer class="layout-footer" data-dashboard-footer-target></footer>

<script>
// --- 1. ZARZƒÑDZANIE STANEM APLIKACJI ---
// Przechowujemy tu dane pobrane z API, aby nie pytaƒá o nie przy ka≈ºdej zmianie selecta.
const AppState = {
    pc: {
        localModelsOllama: [], // Lista modeli z /api/models/installed
        // Hardcoded lista modeli chmurowych (bo API zwraca tylko status kluczy)
        cloudModels: {
            gemini: ['gemini-2.0-flash', 'gemini-1.5-pro', 'gemini-1.5-flash'],
            chatgpt: ['gpt-4o-mini', 'gpt-4o', 'o1-mini']
        },
        // Obecnie aktywna konfiguracja (z /api/models/active)
        activeConfig: { text: {}, vision: {}, voice: {} },
        textProviderStatus: null
    },
    pi: {
        isOnline: false,
        localModels: [], // Modele dostƒôpne na Pi (z proxy)
        activeModelId: null // Aktualnie dzia≈ÇajƒÖcy model na Pi
    }
};

// Elementy DOM do szybkiego dostƒôpu
const DOM = {
    globalStatus: document.getElementById('global-status'),
    piConnectionStatus: document.getElementById('pi-connection-status'),
    keyGemini: document.getElementById('key-status-gemini'),
    keyChatgpt: document.getElementById('key-status-chatgpt'),
    pcEngineStatus: document.getElementById('pc-engine-status'),
    btnRefreshPi: document.getElementById('btn-refresh-pi')
};

const PROVIDER_LABELS = {
    ollama: 'Lokalny (Ollama)',
    local: 'Lokalny (Ollama)',
    gemini: 'Google Gemini',
    chatgpt: 'OpenAI GPT',
    openai: 'OpenAI',
    auto: 'Tryb Auto',
    whisper: 'Whisper',
    piper: 'Piper',
    yolo: 'YOLO'
};

const LOCAL_PROVIDERS = new Set(['local', 'ollama', 'whisper', 'piper', 'yolo']);
const CLOUD_PROVIDERS = new Set(['gemini', 'chatgpt', 'openai', 'auto']);


// --- 2. INICJALIZACJA ---
document.addEventListener('DOMContentLoaded', async () => {
    setupEventListeners();
    await loadAllData(); // Pierwsze ≈Çadowanie danych
});

function setupEventListeners() {
    // Nas≈Çuchuj zmian ≈∫r√≥d≈Ça (Local vs Cloud) w ka≈ºdym kaflu
    document.querySelectorAll('.source-select').forEach(select => {
        select.addEventListener('change', handleSourceChange);
    });

    // Nas≈Çuchuj przycisk√≥w "Zapisz"
    document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', handleSaveConfig);
    });

    // Przycisk od≈õwie≈ºania Pi
    if(DOM.btnRefreshPi) DOM.btnRefreshPi.addEventListener('click', loadPiDataOnly);
}


// --- 3. G≈Å√ìWNA PƒòTLA ≈ÅADOWANIA DANYCH (Concurrent Fetch) ---
async function loadAllData() {
    updateGlobalStatus('working', 'Synchronizacja system√≥w...');
    
    try {
        // Wykonujemy wszystkie zapytania r√≥wnolegle dla szybko≈õci.
        // Promise.allSettled pozwala nam obs≈Çu≈ºyƒá b≈ÇƒÖd Pi niezale≈ºnie od sukcesu PC.
        const [installedRes, activeRes, cloudRes, piRes, textProviderRes] = await Promise.allSettled([
            fetch('/api/models/installed'),     // Modele lokalne PC (Ollama)
            fetch('/api/models/active'),        // Co jest teraz aktywne na PC?
            fetch('/api/providers/text/external'), // Status kluczy API
            fetch('/api/proxy/pi/status'),      // Proxy do Rider-Pi
            fetch('/api/providers/text', { cache: 'no-store' }) // Telemetria providera tekstowego
        ]);

        // --- Przetwarzanie odpowiedzi PC ---
        
        // 1. Zainstalowane modele Ollama
        if (installedRes.status === 'fulfilled' && installedRes.value.ok) {
            const data = await installedRes.value.json();
            AppState.pc.localModelsOllama = data.ollama || [];
            renderPcEngineStatus(AppState.pc.localModelsOllama.length > 0);
        }

        // 2. Aktywna konfiguracja PC
        if (activeRes.status === 'fulfilled' && activeRes.value.ok) {
            AppState.pc.activeConfig = await activeRes.value.json();
        }

        // 3. Status kluczy w chmurze
        if (cloudRes.status === 'fulfilled' && cloudRes.value.ok) {
            const data = await cloudRes.value.json();
            updateKeyStatus(DOM.keyGemini, data.gemini?.has_api_key);
            updateKeyStatus(DOM.keyChatgpt, data.chatgpt?.has_api_key);
        }

        // 4. Status providera tekstowego (backend: lokalny/chmura)
        if (textProviderRes.status === 'fulfilled' && textProviderRes.value.ok) {
            AppState.pc.textProviderStatus = await textProviderRes.value.json();
        } else {
            AppState.pc.textProviderStatus = null;
        }

        // --- Przetwarzanie odpowiedzi Pi ---
        if (piRes.status === 'fulfilled' && piRes.value.ok) {
            // Pi jest online
            const data = await piRes.value.json();
            AppState.pi.isOnline = true;
            AppState.pi.localModels = data.available_models || [];
            AppState.pi.activeModelId = data.active_model;
            updatePiConnectionStatus(true);
            renderPiHealth(data);
        } else {
            // Pi jest offline lub b≈ÇƒÖd proxy
            AppState.pi.isOnline = false;
            updatePiConnectionStatus(false);
            renderPiHealth(null);
        }

        // --- Finalizacja ---
        syncTextConfigWithBackend();
        // Po za≈Çadowaniu wszystkich danych, od≈õwie≈ºamy ca≈Çy interfejs
        refreshEntireUI();
        updateGlobalStatus('success', 'Gotowy');

    } catch (err) {
        console.error("Critical Init Error:", err);
        updateGlobalStatus('err', 'B≈ÇƒÖd inicjalizacji API');
    }
}


// --- 4. LOGIKA OD≈öWIE≈ªANIA UI ---

// Funkcja g≈Ç√≥wna, kt√≥ra ustawia stan wszystkich kafli na podstawie AppState
function refreshEntireUI() {
    
    // A. Od≈õwie≈º kafle PC (Text, Vision, Voice)
    ['text', 'vision', 'voice'].forEach(domain => {
        const card = document.getElementById(`card-pc-${domain}`);
        if (!card) return;

        const activeConf = getEffectiveConfigForDomain(domain);
        const sourceSelect = card.querySelector('.source-select');
        const modelSelect = card.querySelector('.model-select');

        // 1. Zaktualizuj pasek statusu "Aktywny:"
        updateActiveStatusbar(card, activeConf);

        // 2. Ustaw selecty na podstawie aktywnej konfiguracji (je≈õli istnieje)
        if (activeConf && activeConf.provider && domain === 'text') {
            const isCloud = isCloudProvider(activeConf.provider);
            sourceSelect.value = isCloud ? 'cloud' : 'local';
            
            // Wype≈Çnij listƒô modeli na podstawie wybranego ≈∫r√≥d≈Ça
            populateModelSelect(card, sourceSelect.value);

            // Spr√≥buj zaznaczyƒá aktywny model na li≈õcie
            if (activeConf.model) {
                 modelSelect.value = activeConf.model;
                 // Fallback: je≈õli modelu nie ma na li≈õcie (np. b≈ÇƒÖd nazwy), wybierz pierwszy
                 if(modelSelect.selectedIndex === -1 && modelSelect.options.length > 0) {
                     modelSelect.selectedIndex = 0;
                 }
            }
        } else if (domain === 'text') {
            // Stan domy≈õlny dla Vision/Voice lub gdy brak konfigu
            populateModelSelect(card, sourceSelect.value);
        }
    });

    // B. Od≈õwie≈º kafle Pi (W≈ÇƒÖcz/Wy≈ÇƒÖcz w zale≈ºno≈õci od statusu online)
    updatePiCardsState(AppState.pi.isOnline);
}

// Obs≈Çuga zmiany ≈∫r√≥d≈Ça (np. prze≈ÇƒÖczenie z Local na Cloud)
function handleSourceChange(event) {
    const card = event.target.closest('.pipeline-card');
    const newSource = event.target.value;
    // Prze≈Çaduj listƒô modeli dla nowego ≈∫r√≥d≈Ça
    populateModelSelect(card, newSource);
}

// Dynamiczne wype≈Çnianie selecta z modelami
function populateModelSelect(card, source) {
    const modelSelect = card.querySelector('.model-select');
    const domain = card.dataset.domain;
    const device = card.dataset.device;

    if (!((device === 'pc' && domain === 'text') || (device === 'pi' && domain === 'text'))) {
        return; // Pozostaw domy≈õlne opcje dla pozosta≈Çych kafli
    }

    modelSelect.innerHTML = ''; // Wyczy≈õƒá obecnƒÖ listƒô

    let optionsBuilder = [];

    if (device === 'pc') {
        // --- Logika dla PC ---
        if (domain === 'text') {
            if (source === 'local') {
                // Modele Ollama z AppState
                optionsBuilder = AppState.pc.localModelsOllama.map(m => ({ val: m.name, text: `ü¶ô ${m.name}` }));
            } else if (source === 'cloud') {
                // Hardcoded modele chmurowe
                optionsBuilder = [
                    { optgroup: 'Google Gemini' },
                    ...AppState.pc.cloudModels.gemini.map(m => ({ val: m, text: `üî∑ ${m}` })),
                    { optgroup: 'OpenAI ChatGPT' },
                    ...AppState.pc.cloudModels.chatgpt.map(m => ({ val: m, text: `üíö ${m}` }))
                ];
            }
        } 
        // (Tutaj mo≈ºna dodaƒá logikƒô dla Vision/Voice w przysz≈Ço≈õci)

    } else if (device === 'pi') {
        // --- Logika dla Pi ---
        if (domain === 'text' && source === 'local' && AppState.pi.isOnline) {
             // Modele pobrane z Pi
             optionsBuilder = AppState.pi.localModels.map(m => ({ val: m.id, text: `ü§ñ ${m.name}` }));
        }
    }

    // Renderowanie opcji w selectcie
    if(optionsBuilder.length === 0) {
         modelSelect.innerHTML = '<option disabled selected>Brak dostƒôpnych modeli</option>';
    } else {
        optionsBuilder.forEach(opt => {
            if(opt.optgroup) {
                const group = document.createElement('optgroup'); group.label = opt.optgroup; modelSelect.appendChild(group);
            } else {
                const el = document.createElement('option');
                el.value = opt.val; el.textContent = opt.text;
                modelSelect.appendChild(el);
            }
        });
    }
}


// --- 5. OBS≈ÅUGA AKCJI (ZAPIS) ---

async function handleSaveConfig(event) {
    const btn = event.target;
    const card = btn.closest('.pipeline-card');
    const domain = card.dataset.domain; // text, vision, voice
    const device = card.dataset.device; // pc, pi

    const source = card.querySelector('.source-select').value;
    const model = card.querySelector('.model-select').value;

    if (!model || model.includes('Brak')) { alert("Wybierz poprawny model."); return; }

    // UI Feedback
    const originalText = btn.textContent;
    btn.disabled = true; btn.textContent = "Zapisywanie...";
    updateGlobalStatus('working', `Konfiguracja ${device.toUpperCase()}...`);

    try {
        if (device === 'pc') {
            // --- Zapis na PC (/api/models/bind) ---
            
            // 1. Ustal providera na podstawie wyboru
            let provider = 'local'; // default
            if (source === 'cloud') {
                if (model.includes('gemini')) provider = 'gemini';
                else if (model.includes('gpt') || model.includes('o1')) provider = 'chatgpt';
            } else if (source === 'local' && domain === 'text') {
                provider = 'ollama';
            }
            // Dla vision/voice 'local' jest ok.

            // 2. Wy≈õlij ≈ºƒÖdanie bind
            const res = await fetch('/api/models/bind', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ slot: domain, provider: provider, model: model })
            });
            if (!res.ok) throw new Error(`API Error: ${res.status}`);

            // 3. (Opcjonalnie) Je≈õli zmieniamy text, wymu≈õ te≈º zmianƒô backendu
            if(domain === 'text') {
                 const backend = (provider === 'ollama') ? 'local' : provider;
                 await fetch('/api/providers/text/backend', {
                    method: 'PATCH', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ backend })
                });
            }

        } else if (device === 'pi') {
            // --- Zapis na Pi (Proxy) ---
             const res = await fetch('/api/proxy/pi/set-model', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ domain: domain, model_id: model })
            });
             if (!res.ok) throw new Error("Pi rejected command");
        }

        // Sukces! Prze≈Çaduj dane, aby od≈õwie≈ºyƒá statusy
        await loadAllData(); 
        btn.textContent = "Zapisano ‚úì";
        setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000);

    } catch (e) {
        console.error(e);
        alert("B≈ÇƒÖd zapisu: " + e.message);
        btn.textContent = "B≈ÇƒÖd ‚úó";
        btn.disabled = false;
        updateGlobalStatus('err', 'Niepowodzenie');
    }
}


// --- 6. FUNKCJE POMOCNICZE UI ---

// Aktualizuje kolorowy pasek statusu w kaflu
function updateActiveStatusbar(card, config) {
    const statusBar = card.querySelector('.active-status-bar');
    const valueEl = statusBar.querySelector('.status-value');
    
    statusBar.classList.remove('is-active-local', 'is-active-cloud');

    if (!config || !config.model) {
        valueEl.textContent = "‚Äî"; return;
    }

    // Skr√≥ƒá nazwƒô, je≈õli jest za d≈Çuga
    let displayName = config.model;
    if (displayName.length > 28) displayName = displayName.substring(0, 25) + '...';

    const providerLabel = config.providerLabel || formatProviderLabel(config.provider);
    valueEl.textContent = `${displayName} (${providerLabel || 'n/a'})`;

    // Kolorowanie paska
    if (isLocalProvider(config.provider)) {
        statusBar.classList.add('is-active-local'); // Zielony
    } else if (isCloudProvider(config.provider)) {
        statusBar.classList.add('is-active-cloud'); // Niebieski
    }
}

// Aktywuje/dezaktywuje kafle Pi w zale≈ºno≈õci od po≈ÇƒÖczenia
function updatePiCardsState(isOnline) {
    const piCard = document.getElementById('card-pi-text');
    const inputs = piCard.querySelectorAll('.c-select, .save-btn');
    const modelSel = piCard.querySelector('.model-select');
    const statusVal = piCard.querySelector('.status-value');

    inputs.forEach(el => el.disabled = !isOnline);
    DOM.btnRefreshPi.disabled = !isOnline;

    if(isOnline) {
        // Je≈õli online, znajd≈∫ aktywny model i ustaw go w statusie
        const activeModel = AppState.pi.localModels.find(m => m.id === AppState.pi.activeModelId);
        statusVal.textContent = activeModel ? activeModel.name : (AppState.pi.activeModelId || 'Nieznany');
        
        // Od≈õwie≈º listƒô modeli (bo mog≈Ça byƒá pusta jak by≈Ç offline)
        populateModelSelect(piCard, 'local');
    } else {
        modelSel.innerHTML = '<option>Brak po≈ÇƒÖczenia</option>';
        statusVal.textContent = "Offline";
    }
}

// Renderuje statusy kluczy API
function updateKeyStatus(el, hasKey) {
    el.textContent = hasKey ? "Gotowy" : "Brak";
    el.className = hasKey ? "c-pill c-pill--sm is-success" : "c-pill c-pill--sm is-off";
}

// Renderuje status silnika PC
function renderPcEngineStatus(hasOllama) {
    DOM.pcEngineStatus.innerHTML = hasOllama 
        ? '<span class="c-text-success">‚úî Ollama wykryta. Silnik gotowy.</span>'
        : '<span class="c-text-err">‚úò Brak modeli Ollama. Zainstaluj je w terminalu.</span>';
}

// Renderuje zdrowie Pi
function renderPiHealth(data) {
    const pingEl = document.getElementById('pi-health-ping');
    const cpuEl = document.getElementById('pi-health-cpu');
    if(data) {
        pingEl.textContent = (data.latency_ms || 15) + 'ms';
        cpuEl.textContent = (data.cpu_usage || 5) + '%';
    } else {
        pingEl.textContent = "‚Äî"; cpuEl.textContent = "‚Äî";
    }
}

// Globalne statusy w nag≈Ç√≥wkach
function updateGlobalStatus(state, text) {
    DOM.globalStatus.textContent = text;
    DOM.globalStatus.className = `c-pill is-${state}`;
}

function updatePiConnectionStatus(isOnline) {
    DOM.piConnectionStatus.textContent = isOnline ? "Pi Po≈ÇƒÖczony" : "Pi Offline";
    DOM.piConnectionStatus.className = isOnline ? "c-pill is-success" : "c-pill is-off";
}

// Wrapper do rƒôcznego od≈õwie≈ºania tylko Pi
async function loadPiDataOnly() {
    updateGlobalStatus('working', 'Od≈õwie≈ºanie Pi...');
    try {
        const res = await fetch('/api/proxy/pi/status');
        if(res.ok) {
             const data = await res.json();
             AppState.pi.isOnline = true;
             AppState.pi.localModels = data.available_models || [];
             AppState.pi.activeModelId = data.active_model;
             updatePiConnectionStatus(true);
             renderPiHealth(data);
        } else { throw new Error(); }
    } catch(e) {
         AppState.pi.isOnline = false;
         updatePiConnectionStatus(false);
         renderPiHealth(null);
    }
    refreshEntireUI();
    updateGlobalStatus('success', 'Gotowy');
}

// --- 7. DODATKOWE FUNKCJE POMOCNICZE ---

function syncTextConfigWithBackend() {
    const status = AppState.pc.textProviderStatus || {};
    const base = AppState.pc.activeConfig.text || {};
    const normalizedBackend = normalizeProvider(status.backend);
    AppState.pc.activeConfig.text = {
        ...base,
        provider: normalizedBackend || base.provider,
        backend: normalizedBackend || base.backend,
        model: status.model || base.model,
        providerLabel: formatProviderLabel(normalizedBackend || base.provider)
    };
}

function getEffectiveConfigForDomain(domain) {
    const base = { ...(AppState.pc.activeConfig[domain] || {}) };
    base.providerLabel = formatProviderLabel(base.provider);

    if (domain === 'text') {
        const status = AppState.pc.textProviderStatus;
        if (status) {
            const normalizedBackend = normalizeProvider(status.backend);
            if (normalizedBackend) {
                base.provider = normalizedBackend;
                base.backend = normalizedBackend;
                base.providerLabel = formatProviderLabel(normalizedBackend);
            }
            if (status.model) {
                base.model = status.model;
            }
        }
    }
    return base;
}

function normalizeProvider(name) {
    if (!name) return undefined;
    const lower = name.toLowerCase();
    if (lower === 'local') return 'ollama';
    return lower;
}

function formatProviderLabel(name) {
    if (!name) return '';
    const lower = name.toLowerCase();
    return PROVIDER_LABELS[lower] || name;
}

function isLocalProvider(name) {
    if (!name) return false;
    return LOCAL_PROVIDERS.has(name.toLowerCase());
}

function isCloudProvider(name) {
    if (!name) return false;
    return CLOUD_PROVIDERS.has(name.toLowerCase());
}
</script>
<script type="module" src="/web/assets/menu.js"></script>
<script type="module" src="/web/assets/footer.js"></script>
</body>
</html>
