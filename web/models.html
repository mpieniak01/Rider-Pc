<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Modele AI ‚Äì Rider-PC</title>
  <link rel="stylesheet" href="/web/assets/dashboard-common.css">
  <link rel="stylesheet" href="/web/assets/models.css">
</head>
<body data-page="models">
<div data-dashboard-menu-target></div>
<div class="models-shell">
  <header>
    <h1 class="page-title">ü§ñ Modele AI</h1>
    <p class="page-subtitle">ZarzƒÖdzanie modelami sztucznej inteligencji</p>
  </header>

<p id="status-line" class="status-line">≈Åadowanie danych modeli...</p>

  <!-- Active Models Section -->
  <section class="models-section">
    <h2 class="section-title">üìä Aktywne Modele</h2>
    <div class="models-grid" id="active-models-grid">
      <!-- Active model cards will be dynamically inserted -->
    </div>
  </section>

  <!-- Provider State -->
  <section class="models-section">
    <h2 class="section-title">üõ∞Ô∏è Stan Rider-Pi</h2>
    <p class="section-desc">Informacje z rejestru providera Rider-Pi: gdzie wykonywane sƒÖ obecnie zadania Vision / Voice / Text.</p>
    <div class="provider-grid" id="provider-state-grid">
      <div class="loading-placeholder">Oczekiwanie na dane z Rider-Pi...</div>
    </div>
    <p class="provider-note" id="provider-note"></p>
  </section>

  <!-- Vision Models -->
  <section class="models-section">
    <h2 class="section-title">üëÅÔ∏è Wizja (Vision)</h2>
    <p class="section-desc">Modele detekcji obiekt√≥w i analizy obrazu</p>
    <div class="model-category" id="vision-models">
      <div class="loading-placeholder">Skanowanie modeli wizji...</div>
    </div>
  </section>

  <!-- Voice Models -->
  <section class="models-section">
    <h2 class="section-title">üó£Ô∏è Mowa (Audio)</h2>
    <div class="voice-subsections">
      <div class="voice-subsection">
        <h3 class="subsection-title">üé§ ASR (Rozpoznawanie mowy)</h3>
        <div class="model-category" id="voice-asr-models">
          <div class="loading-placeholder">Skanowanie modeli ASR...</div>
        </div>
      </div>
      <div class="voice-subsection">
        <h3 class="subsection-title">üîä TTS (Synteza mowy)</h3>
        <div class="model-category" id="voice-tts-models">
          <div class="loading-placeholder">Skanowanie modeli TTS...</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Text/LLM Models -->
  <section class="models-section">
    <h2 class="section-title">üí¨ Tekst (LLM)</h2>
    <p class="section-desc">Modele jƒôzykowe do generowania tekstu i NLU</p>
    <div class="model-category" id="text-models">
      <div class="loading-placeholder">Skanowanie modeli LLM...</div>
    </div>
  </section>

  <!-- Installed Files -->
  <section class="models-section">
    <h2 class="section-title">üìÅ Zainstalowane Pliki Modeli</h2>
    <p class="section-desc">Pliki modeli wykryte w katalogu <code>data/models/</code></p>
    <div class="installed-columns">
      <div class="installed-column">
        <h3 class="subsection-title">üíª Rider-PC</h3>
        <p class="section-desc">Pliki lokalne u≈ºywane przez providera PC. Klikniƒôcie ‚ÄûAktywuj‚Äù zapisuje konfiguracjƒô i prze≈ÇƒÖcza Rider-Pi w tryb PC.</p>
        <div class="installed-models-table-wrapper">
          <table class="installed-models-table" id="installed-models-table">
            <thead>
              <tr>
                <th>Nazwa</th>
                <th>Kategoria</th>
                <th>Typ</th>
                <th>Format</th>
                <th>Rozmiar</th>
                <th>Akcje</th>
              </tr>
            </thead>
            <tbody id="installed-models-tbody">
              <tr>
                <td colspan="6" class="empty-message">Skanowanie plik√≥w...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="installed-column">
        <h3 class="subsection-title">ü§ñ Rider-Pi</h3>
        <p class="section-desc">Lista plik√≥w zg≈Çaszanych przez API <code>/api/models/installed</code> na Rider-Pi. Przycisk ‚ÄûUstaw lokalnie‚Äù prze≈ÇƒÖcza domenƒô na tryb LOCAL.</p>
        <div class="installed-models-table-wrapper">
          <table class="installed-models-table" id="remote-models-table">
            <thead>
              <tr>
                <th>Nazwa</th>
                <th>Kategoria</th>
                <th>Typ</th>
                <th>Format</th>
                <th>Rozmiar</th>
                <th>Akcje</th>
              </tr>
            </thead>
            <tbody id="remote-models-tbody">
              <tr>
                <td colspan="6" class="empty-message">Brak danych z Rider-Pi...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</div>

<script>
const statusLine = document.getElementById('status-line');
const activeModelsGrid = document.getElementById('active-models-grid');
const visionModels = document.getElementById('vision-models');
const voiceAsrModels = document.getElementById('voice-asr-models');
const voiceTtsModels = document.getElementById('voice-tts-models');
const textModels = document.getElementById('text-models');
const installedTbody = document.getElementById('installed-models-tbody');
const remoteTbody = document.getElementById('remote-models-tbody');
const providerStateGrid = document.getElementById('provider-state-grid');
const providerNote = document.getElementById('provider-note');

// HTML escape function to prevent XSS
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = String(text ?? '');
  return div.innerHTML;
}

const categoryIcons = {
  vision: 'üëÅÔ∏è',
  voice_asr: 'üé§',
  voice_tts: 'üîä',
  text: 'üí¨',
  unknown: '‚ùì'
};

const categoryNames = {
  vision: 'Wizja',
  voice_asr: 'ASR',
  voice_tts: 'TTS',
  text: 'LLM',
  unknown: 'Nieznany'
};

const providerNames = {
  yolo: 'YOLO',
  whisper: 'Whisper',
  piper: 'Piper',
  ollama: 'Ollama',
  openai: 'OpenAI',
  gemini: 'Gemini'
};

function slotToDomain(slot) {
  return slotDomainMap[slot] || slot || 'unknown';
}

function formatRelativeTime(timestamp) {
  if (!timestamp) return '---';
  try {
    const date = new Date(timestamp * 1000);
    const diffMs = Date.now() - date.getTime();
    const diffMinutes = Math.round(diffMs / 60000);
    if (diffMinutes < 1) return 'przed chwilƒÖ';
    if (diffMinutes === 1) return 'minutƒô temu';
    if (diffMinutes < 60) return `${diffMinutes} min temu`;
    const diffHours = Math.round(diffMinutes / 60);
    if (diffHours === 1) return 'godzinƒô temu';
    return `${diffHours} h temu`;
  } catch (err) {
    return '---';
  }
}

const domainLabels = {
  vision: 'Wizja',
  voice: 'Mowa',
  text: 'Tekst'
};

function createProviderCard(domain, state) {
  const card = document.createElement('div');
  card.className = 'provider-card';
  const mode = (state.mode || 'local').toLowerCase() === 'pc' ? 'pc' : 'local';
  const status = (state.status || 'unknown').replace('_', ' ');
  const modeLabel = mode === 'pc' ? 'PC (offload)' : 'Lokalny';
  const modeClass = mode === 'pc' ? 'mode-pc' : 'mode-local';
  const changed = formatRelativeTime(state.changed_ts);
  const reason = escapeHtml(state.reason || '');

  card.innerHTML = `
    <div class="provider-card-head">
      <div>
        <div class="provider-domain">${escapeHtml(domainLabels[domain] || domain)}</div>
        <div class="provider-status-pill">${escapeHtml(status)}</div>
      </div>
      <span class="provider-mode ${modeClass}">${modeLabel}</span>
    </div>
    <div class="provider-card-body">
      <div class="provider-meta">
        <span class="meta-item">‚è±Ô∏è ${changed}</span>
        ${reason ? `<span class="meta-item">‚ÑπÔ∏è ${reason}</span>` : ''}
      </div>
    </div>
  `;
  return card;
}

function renderProviderState(payload) {
  if (!payload || !payload.domains) {
    providerStateGrid.innerHTML = '<div class="no-models">Brak danych z Rider-Pi.</div>';
    providerNote.textContent = '';
    return;
  }

  providerStateGrid.innerHTML = '';
  Object.entries(payload.domains).forEach(([domain, state]) => {
    providerStateGrid.appendChild(createProviderCard(domain, state || {}));
  });

  const health = payload.pc_health || {};
  const reachable = health.reachable ? 'po≈ÇƒÖczony' : 'offline';
  const latency = typeof health.latency_ms === 'number' ? `${health.latency_ms.toFixed(0)} ms` : '---';
  providerNote.textContent = `PC wed≈Çug Rider-Pi: ${reachable} (status ${health.status || 'unknown'}, RTT ${latency})`;
}

const slotDomainMap = {
  vision: 'vision',
  voice_asr: 'voice',
  voice_tts: 'voice',
  text: 'text'
};

function createActiveModelCard(category, config) {
  const card = document.createElement('div');
  card.className = 'active-model-card';
  
  const enabled = config.enabled !== false;
  const useMock = config.use_mock === true;
  
  let statusClass = 'status-inactive';
  let statusText = 'Wy≈ÇƒÖczony';
  if (useMock) {
    statusClass = 'status-mock';
    statusText = 'Mock';
  } else if (enabled) {
    statusClass = 'status-active';
    statusText = 'Aktywny';
  }
  
  const safeCategory = escapeHtml(categoryNames[category] || category);
  const safeModel = escapeHtml(config.model || 'N/A');
  const safeProvider = escapeHtml(providerNames[config.provider] || config.provider || 'N/A');
  
  card.innerHTML = `
    <div class="active-model-header">
      <span class="active-model-icon">${categoryIcons[category] || 'ü§ñ'}</span>
      <span class="active-model-category">${safeCategory}</span>
      <span class="active-model-status ${statusClass}">${escapeHtml(statusText)}</span>
    </div>
    <div class="active-model-info">
      <div class="info-row">
        <span class="info-label">Model:</span>
        <span class="info-value model-name">${safeModel}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Provider:</span>
        <span class="info-value">${safeProvider}</span>
      </div>
    </div>
  `;
  
  return card;
}

function createOllamaModelCard(model) {
  const card = document.createElement('div');
  card.className = 'model-card ollama-model';
  
  const name = model.name || model.model || 'Unknown';
  const size = model.size ? formatSize(model.size) : 'N/A';
  const modified = model.modified_at ? new Date(model.modified_at).toLocaleDateString() : '';
  
  const safeName = escapeHtml(name);
  const safeSize = escapeHtml(size);
  const safeModified = escapeHtml(modified);
  
  card.innerHTML = `
    <div class="model-card-header">
      <span class="model-name">${safeName}</span>
      <span class="model-provider ollama">Ollama</span>
    </div>
    <div class="model-card-body">
      <div class="model-meta">
        <span class="meta-item">üì¶ ${safeSize}</span>
        ${safeModified ? `<span class="meta-item">üìÖ ${safeModified}</span>` : ''}
      </div>
    </div>
    <div class="model-card-actions">
      <button class="btn-activate" data-origin="pc" data-model="${safeName}" data-provider="ollama" data-slot="text">
        Aktywuj
      </button>
    </div>
  `;
  
  return card;
}

function createLocalModelCard(model) {
  const card = document.createElement('div');
  card.className = 'model-card local-model';
  
  const safeName = escapeHtml(model.name);
  const safeFormat = escapeHtml(model.format);
  const safePath = escapeHtml(model.path);
  const safeType = escapeHtml(model.type);
  const safeCategory = escapeHtml(model.category);
  const safeSize = escapeHtml(model.size_mb.toFixed(1));
  
  card.innerHTML = `
    <div class="model-card-header">
      <span class="model-name">${safeName}</span>
      <span class="model-format">.${safeFormat}</span>
    </div>
    <div class="model-card-body">
      <div class="model-meta">
        <span class="meta-item">üì¶ ${safeSize} MB</span>
        <span class="meta-item">üìÅ ${safePath}</span>
      </div>
    </div>
    <div class="model-card-actions">
      <button class="btn-activate" data-origin="pc" data-model="${safeName}" data-provider="${safeType}" data-slot="${safeCategory}">
        Aktywuj
      </button>
    </div>
  `;
  
  return card;
}

function formatSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.min(Math.floor(Math.log(bytes) / Math.log(k)), sizes.length - 1);
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function renderActiveModels(active) {
  activeModelsGrid.innerHTML = '';
  
  const categories = ['vision', 'voice_asr', 'voice_tts', 'text'];
  categories.forEach(cat => {
    const config = active[cat];
    if (config) {
      const card = createActiveModelCard(cat, config);
      activeModelsGrid.appendChild(card);
    }
  });
}

function renderInstalledModels(local, ollama, remote) {
  installedTbody.innerHTML = '';
  
  if (!local.length && !ollama.length) {
    installedTbody.innerHTML = `
      <tr>
        <td colspan="6" class="empty-message">
          Brak wykrytych plik√≥w modeli w katalogu <code>data/models/</code>
        </td>
      </tr>
    `;
    return;
  }
  
  // Add local models
  local.forEach(model => {
    const safeName = escapeHtml(model.name);
    const safeCategory = escapeHtml(categoryNames[model.category] || model.category);
    const safeCategoryClass = escapeHtml(model.category);
    const safeType = escapeHtml(model.type);
    const safeFormat = escapeHtml(model.format);
    const safeSize = escapeHtml(model.size_mb.toFixed(1));
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="model-name-cell">${safeName}</span></td>
      <td><span class="category-badge ${safeCategoryClass}">${safeCategory}</span></td>
      <td>${safeType}</td>
      <td><code>.${safeFormat}</code></td>
      <td>${safeSize} MB</td>
      <td>
        <button class="btn-sm btn-activate" data-origin="pc" data-model="${safeName}" data-slot="${safeCategoryClass}">
          Aktywuj
        </button>
      </td>
    `;
    installedTbody.appendChild(tr);
  });
  
  // Add Ollama models
  ollama.forEach(model => {
    const name = model.name || model.model || 'Unknown';
    const size = model.size ? formatSize(model.size) : 'N/A';
    
    const safeName = escapeHtml(name);
    const safeSize = escapeHtml(size);
    
    const tr = document.createElement('tr');
    tr.classList.add('ollama-row');
    tr.innerHTML = `
      <td><span class="model-name-cell">${safeName}</span></td>
      <td><span class="category-badge text">LLM</span></td>
      <td>ollama</td>
      <td><code>gguf</code></td>
      <td>${safeSize}</td>
      <td>
        <button class="btn-sm btn-activate" data-origin="pc" data-model="${safeName}" data-provider="ollama" data-slot="text">
          Aktywuj
        </button>
      </td>
    `;
    installedTbody.appendChild(tr);
  });

  renderRemoteModels(remote);
}

function renderRemoteModels(remote) {
  remoteTbody.innerHTML = '';

  if (!remote.length) {
    remoteTbody.innerHTML = `
      <tr>
        <td colspan="6" class="empty-message">
          Brak danych zwr√≥conych przez Rider-Pi. Upewnij siƒô, ≈ºe API /api/models/installed jest dostƒôpne.
        </td>
      </tr>
    `;
    return;
  }

  remote.forEach(model => {
    const safeName = escapeHtml(model.name || 'Unknown');
    const slot = escapeHtml(model.category || 'unknown');
    const safeType = escapeHtml(model.type || 'unknown');
    const safeFormat = escapeHtml(model.format || '?');
    const sizeValue =
      typeof model.size_mb === 'number' ? `${model.size_mb.toFixed(1)} MB` : escapeHtml(String(model.size_mb || '---'));

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="model-name-cell">${safeName}</span></td>
      <td><span class="category-badge ${slot}">${escapeHtml(categoryNames[model.category] || model.category || '---')}</span></td>
      <td>${safeType}</td>
      <td><code>.${safeFormat}</code></td>
      <td>${sizeValue}</td>
      <td>
        <button class="btn-sm btn-activate" data-origin="rider-pi" data-slot="${slot}" data-model="${safeName}">
          Ustaw lokalnie
        </button>
      </td>
    `;
    remoteTbody.appendChild(tr);
  });
}

function renderCategoryModels(local, ollama) {
  // Vision models
  const visionLocal = local.filter(m => m.category === 'vision');
  if (visionLocal.length > 0) {
    visionModels.innerHTML = '';
    visionLocal.forEach(m => {
      visionModels.appendChild(createLocalModelCard(m));
    });
  } else {
    visionModels.innerHTML = '<div class="no-models">Brak lokalnych modeli wizji. Konfiguracja z providers.toml.</div>';
  }
  
  // Voice ASR models
  const asrLocal = local.filter(m => m.category === 'voice_asr');
  if (asrLocal.length > 0) {
    voiceAsrModels.innerHTML = '';
    asrLocal.forEach(m => {
      voiceAsrModels.appendChild(createLocalModelCard(m));
    });
  } else {
    voiceAsrModels.innerHTML = '<div class="no-models">Brak lokalnych modeli ASR. Konfiguracja z providers.toml.</div>';
  }
  
  // Voice TTS models
  const ttsLocal = local.filter(m => m.category === 'voice_tts');
  if (ttsLocal.length > 0) {
    voiceTtsModels.innerHTML = '';
    ttsLocal.forEach(m => {
      voiceTtsModels.appendChild(createLocalModelCard(m));
    });
  } else {
    voiceTtsModels.innerHTML = '<div class="no-models">Brak lokalnych modeli TTS. Konfiguracja z providers.toml.</div>';
  }
  
  // Text/LLM models (Ollama)
  if (ollama.length > 0) {
    textModels.innerHTML = '';
    ollama.forEach(m => {
      textModels.appendChild(createOllamaModelCard(m));
    });
  } else {
    const textLocal = local.filter(m => m.category === 'text');
    if (textLocal.length > 0) {
      textModels.innerHTML = '';
      textLocal.forEach(m => {
        textModels.appendChild(createLocalModelCard(m));
      });
    } else {
      textModels.innerHTML = '<div class="no-models">Brak modeli LLM. Ollama niedostƒôpna lub brak modeli lokalnych.</div>';
    }
  }
}

async function activateModel(slot, provider, model) {
  const domain = slotToDomain(slot);
  const domainLabel = domainLabels[domain] || categoryNames[slot] || slot;
  try {
    statusLine.textContent = `Aktywujƒô model ${model} (domena ${domainLabel})...`;
    statusLine.className = 'status-line working';
    
    const response = await fetch('/api/models/bind', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ slot, provider, model })
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      if (result.provider_switch && result.provider_switch.error) {
        statusLine.textContent = `‚ö†Ô∏è Model ${model} zapisany, ale prze≈ÇƒÖczenie Rider-Pi nie powiod≈Ço siƒô: ${result.provider_switch.error}`;
        statusLine.className = 'status-line error';
      } else {
        statusLine.textContent = `‚úÖ Model ${model} aktywowany dla ${domainLabel} (Rider-Pi prze≈ÇƒÖczony na PC)`;
        statusLine.className = 'status-line success';
      }
      setTimeout(loadModelsData, 1000);
    } else {
      statusLine.textContent = `‚ùå B≈ÇƒÖd: ${result.error || 'Nie uda≈Ço siƒô aktywowaƒá modelu'}`;
      statusLine.className = 'status-line error';
    }
  } catch (error) {
    console.error('Activation error:', error);
    statusLine.textContent = `‚ùå B≈ÇƒÖd po≈ÇƒÖczenia: ${error.message}`;
    statusLine.className = 'status-line error';
  }
}

async function switchProviderToLocal(slot, model) {
  const domain = slotToDomain(slot);
  const domainLabel = domainLabels[domain] || categoryNames[slot] || slot;
  try {
    statusLine.textContent = `Prze≈ÇƒÖczam Rider-Pi na lokalny model ${model} (${domainLabel})...`;
    statusLine.className = 'status-line working';
    
    const response = await fetch(`/api/providers/${domain}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ target: 'local', reason: 'models_ui' })
    });
    
    const result = await response.json();
    
    if (response.ok && !result.error) {
      statusLine.textContent = `‚úÖ Domena ${domainLabel} ustawiona na Rider-Pi (lokalnie)`;
      statusLine.className = 'status-line success';
      // Refresh data
      setTimeout(loadModelsData, 1000);
    } else {
      statusLine.textContent = `‚ùå B≈ÇƒÖd prze≈ÇƒÖczania Rider-Pi: ${result.error || 'Nieznany b≈ÇƒÖd'}`;
      statusLine.className = 'status-line error';
    }
  } catch (error) {
    console.error('Provider switch error:', error);
    statusLine.textContent = `‚ùå B≈ÇƒÖd po≈ÇƒÖczenia z Rider-Pi: ${error.message}`;
    statusLine.className = 'status-line error';
  }
}

// Event delegation for activate buttons
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.btn-activate');
  if (btn) {
    const model = btn.dataset.model;
    const slot = btn.dataset.slot;
    const origin = btn.dataset.origin || 'pc';
    if (model && slot) {
      if (origin === 'rider-pi') {
        switchProviderToLocal(slot, model);
      } else {
        const provider = btn.dataset.provider || 'local';
        activateModel(slot, provider, model);
      }
    }
  }
});

async function loadModelsData() {
  try {
    statusLine.textContent = 'Aktualizujƒô dane modeli...';
    statusLine.className = 'status-line';
    
    const [installedResp, activeResp, providerResp] = await Promise.all([
      fetch('/api/models/installed', { cache: 'no-store' }),
      fetch('/api/models/active', { cache: 'no-store' }),
      fetch('/api/providers/state', { cache: 'no-store' })
    ]);
    const installedData = installedResp.ok ? await installedResp.json() : { local: [], ollama: [], remote: [] };
    const activeData = activeResp.ok ? await activeResp.json() : {};
    const providerState = providerResp.ok ? await providerResp.json() : null;
    
    // Render UI
    renderActiveModels(activeData);
    renderCategoryModels(installedData.local || [], installedData.ollama || []);
    renderInstalledModels(installedData.local || [], installedData.ollama || [], installedData.remote || []);
    renderProviderState(providerState);
    
    const timestamp = new Date().toLocaleTimeString();
    const localCount = (installedData.local || []).length;
    const ollamaCount = (installedData.ollama || []).length;
    const remoteCount = (installedData.remote || []).length;
    statusLine.textContent = `Ostatnia aktualizacja: ${timestamp} | PC: ${localCount} | Ollama: ${ollamaCount} | Rider-Pi: ${remoteCount}`;
    statusLine.className = 'status-line';
    
  } catch (error) {
    console.error('Error loading models data:', error);
    statusLine.textContent = `‚ùå B≈ÇƒÖd podczas pobierania danych: ${error.message}`;
    statusLine.className = 'status-line error';
  }
}

// Initial load
loadModelsData();

// Auto-refresh every 60 seconds (model data doesn't change frequently)
setInterval(loadModelsData, 60000);
</script>

<script type="module" src="/web/assets/menu.js"></script>
</body>
</html>
